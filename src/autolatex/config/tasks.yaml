# 任务0：文档解析任务 (整个流程的起点)
doc_parsing_task:
  description: >
    调用文件读取工具，读取位于 {file_path} 的原始文档（支持 Word, Markdown, Txt 等格式）。
    
    使用文档解析工具读取文件。
    【重要】：不要在回答中输出论文正文！
    请将解析后的完整内容通过工具保存为 'parsed_content.json' 文件。
    最终只返回元数据(metadata)和该文件的路径(content_file_path)。
  expected_output: >
    一个标准化的 JSON 对象。
    结构应包含：{'title': '...', 'authors': [...], 'sections': [{'header': '...', 'content': '...'}]}。
    确保内容清晰、层级分明，作为后续排版工作的文本基石。
  agent: doc_parser_agent

# 任务1：C同学的任务 - 识别公式和表格
# 对应流程图左上角：调用工具/生成LaTeX片段
equation_recognition_task:
  description: >
    分析位于 {formula_position} 的公式图片。
    识别图片中所有复杂的视觉元素，特别是行内或块级的数学公式，以及作为图片存在的表格。
    调用指定的 OCR 工具，将这些视觉元素精准转换为标准的 LaTeX 代码片段。
  expected_output: >
    输出为data\uploads\equation下相对应公式的json文档，文档名称为公式图片名称，包含所有识别出的公式和表格的 LaTeX 代码片段，
  agent: latex_equation_form_agent

# 任务2：模板专家的任务 - 找模板
template_retrieval_task:
  description: >
    根据用户指定的投稿期刊名称："{journal_name}"，在知识库或互联网中检索最匹配的 LaTeX 模板（例如 IEEEtran, ACM, Nature, CVPR）。
    提取该模板的核心排版规则，包括：
    1. 正确的文档类声明（\documentclass ...）。
    2. 必须引入的宏包（packages）。
    3. 标题、作者、摘要和章节的特定格式要求。
  expected_output: >
    一份详细的模板分析摘要，包含确切的模板名称、\documentclass 设置命令，
    以及该期刊排版所需的关键宏包列表和注意事项。
  agent: template_researcher_agent

# 任务3：排版工程师的任务 - 协调与集成
latex_generation_task:
  description: >
    扮演核心协调员的角色。汇总以下来源的所有信息：
    1. 文档解析器提供的结构化文本内容（来自 context），包含了文章的标题、作者、章节正文以及文献参考资料引用。注意，这里的公式块可能只有图片路径。
    2. equation_recognition_task 提供的 OCR 公式片段。
    3. template_retrieval_task 提供的模板格式规则。

    将这些信息合并为一个完整、逻辑连贯且语法正确的 .tex 源文件。
    具体要求：
    - 对于图片处理，当遇到 `{"type": "image", "path": "...", "caption": "..."}` 节点时：
    提取 `path` 字段的值（例如 `E:\...\img.png`），**路径格式修正**：将路径中的反斜杠 `\` 替换为正斜杠 `/` (例如 `E:/.../img.png`)，否则 LaTeX 编译会报错。生成标准的 figure 环境代码。
    - 对于公式的处理，当遇到`\formula{}`时在{data\uploads\equation}下找到对应名字的json文件，将其中的关于公式的Latex代码插入论文的相应位置。
    - 严格应用目标期刊的模板结构（如 \section, \author, \abstract）。
    - 确保所有的宏包引用完整，且图片路径正确。

    ⚠️ **致命规则 (CRITICAL RULES):**
    1. **严禁**在最终回复 (Final Answer) 中输出任何 LaTeX 代码！因为这会导致 Token 溢出。
    2. 你必须通过 **调用工具 (`SectionWriterTool`)** 将代码直接写入硬盘。
    3. **必须分章节写入**，不要试图把所有内容写在一个文件里。
    4. 必须生成与json中参考文献相匹配的.bib文件
    5. 在生成 main.tex 时，\bibliography{...} 命令中只能填写文件名（例如 main），严禁包含文件夹路径（如 output/temp_source/main），因为编译时main.tex与main.bib都在同一目录下。
    6. 生成的main.bib中的文献引用变量名应与.tex中的对应
    7. 若论文模板为双栏格式且有超过五列的表格，那么表格应两列都占，即
    \\begin{table*}[htbp]  % 注意这里的星号*
      表格
    \\end{table*}
    8. 若公式太长，应使用split将其分为两行

    **执行流程:**
    1. **读取数据**: 使用 `FileReadTool` 读取上一步生成的 JSON。
    2. **写入主文件**: 生成 `main.tex` (包含 \documentclass, \usepackage 等)，调用工具写入 `output/temp_source/main.tex`。
    3. **循环写入章节**:
       - 提取摘要 -> 生成 LaTeX -> 调用工具写入 `output/temp_source/sec/abstract.tex`。
       - 提取引言 -> 生成 LaTeX -> 调用工具写入 `output/temp_source/sec/intro.tex`。
       - ... (对每个章节重复此步骤)
    4. **写入参考文献**: 生成 bib 内容 -> 调用工具写入 `output/temp_source/main.bib`。

    ⚠️ **针对长章节的特殊处理规则 (CRITICAL FOR LONG SECTIONS):**
    对于像 "Experiments" 或 "Methodology" 这样内容很长的章节，**严禁**试图一次性写入一个文件（例如 `sec/experiments.tex`），因为这会导致截断循环。
    
    **你必须采取“子文件拆分策略”：**
    1. 不要创建巨大的 `sec/experiments.tex`。
    2. 而是将其拆分为多个小文件，例如：
       - `sec/exp_setup.tex` (实验设置)
       - `sec/exp_tables.tex` (表格数据)
       - `sec/exp_results.tex` (结果分析)
       - `sec/exp_ablation.tex` (消融实验)
    3. 然后，创建一个主索引文件 `sec/experiments.tex`，在里面只写：
       ```latex
       \section[[Experiments]]      在文件中应该使用大括号！！！
       \input[[sec/exp_setup]]      
       \input[[sec/exp_tables]]     
       \input[[sec/exp_results]]    
       ```
    4. 对所有长章节都采用这种 `\input` 嵌套的方式。
    
    只有当所有文件都安全写入硬盘后，你才只需回复一句："所有章节已写入完成"。
  expected_output: >
    一份简短的执行清单。例如："已写入 main.tex, sec/abstract.tex, sec/intro.tex..."。
  agent: latex_coder_agent

# 任务4：调试专家的任务 - 编译与闭环修复
compilation_debugging_task:
  description: >
    你是 LaTeX 编译与调试专家。
    **现状确认**：所有的 .tex 源代码（包含 main.tex 和 sec/ 文件夹）**已经**由上一个 Agent 写入到了本地磁盘 `output/temp_source` 中。
    
    **⚠️ 严格指令 (CRITICAL INSTRUCTIONS):**
    1. **禁止传参**：调用 `LaTeXCompilerTool` 时，**latex_content 参数必须留空 (None)**！工具会自动从硬盘读取。
    2. **禁止输出**：在最终回复中，**严禁**输出完整的 .tex 源代码，只输出状态报告。
    
    **执行步骤：**
    1. **初次编译**：
       - 调用 `LaTeXCompilerTool`。
       - 必须将 **{journal_name}** (例如 "IEEE_Access_LaTeX_template") 赋值给 `template_dir_path` 参数。
    
    2. **循环调试 (如果编译失败)**：
       - **分析日志**：阅读工具返回的 Error Logs。
       - **定位文件**：如果错误发生在某个文件（如 `sec/intro.tex`），使用 `FileReadTool` 读取该**特定文件**的内容（不要读所有文件）。
       - **执行修复**：根据错误原因（如宏包冲突、符号错误），生成修正后的代码片段。
       - **写入硬盘**：立即调用 `SectionWriterTool`，将修正后的内容**覆盖写入**对应的文件。
       - **重试编译**：再次调用 `LaTeXCompilerTool`。
       
    3. **结束任务**：直到编译成功生成 PDF，或达到最大重试次数。

  expected_output: >
    一份简短的编译报告。包含：
    1. **编译状态**：(成功/失败)
    2. **PDF 路径**：(例如 E:\...\output\result_xxx.pdf)
    3. **修复记录**：(如果有修复，简述修改了哪个文件和原因，例如 "修复了 sec/abstract.tex 中的未闭合花括号")
    **不要包含源代码。**
  agent: latex_debugger_agent