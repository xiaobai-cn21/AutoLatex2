# 任务0：文档解析任务 (整个流程的起点)
doc_parsing_task:
  description: >
    调用文件读取工具，读取位于 {file_path} 的原始文档（支持 Word, Markdown, Txt 等格式）。
    
    使用文档解析工具读取文件。
    【重要】：不要在回答中输出论文正文！
    请将解析后的完整内容通过工具保存为 'parsed_content.json' 文件。
    最终只返回元数据(metadata)和该文件的路径(content_file_path)。
  expected_output: >
    一个标准化的 JSON 对象。
    结构应包含：{'title': '...', 'authors': [...], 'sections': [{'header': '...', 'content': '...'}]}。
    确保内容清晰、层级分明，作为后续排版工作的文本基石。
  agent: doc_parser_agent

# 任务1：C同学的任务 - 识别公式和表格
# 对应流程图左上角：调用工具/生成LaTeX片段
equation_recognition_task:
  description: >
    分析位于 {file_path} 的文档。
    识别文档中所有复杂的视觉元素，特别是行内或块级的数学公式，以及作为图片存在的表格。
    调用指定的 OCR 工具（DeepSeek-OCR），将这些视觉元素精准转换为标准的 LaTeX 代码片段。
    务必记录下每个 LaTeX 片段在原文中的上下文位置，以便后续能够准确还原。
  expected_output: >
    一个结构化的 JSON 数据（或列表），包含所有识别出的公式和表格的 LaTeX 代码片段，
    并按其在原文档中的出现顺序或 ID 进行了索引。
  agent: latex_equation_form_agent

# 任务2：模板专家的任务 - 找模板
template_retrieval_task:
  description: >
    根据用户指定的投稿期刊名称："{journal_name}"，在知识库或互联网中检索最匹配的 LaTeX 模板（例如 IEEEtran, ACM, Nature, CVPR）。
    提取该模板的核心排版规则，包括：
    1. 正确的文档类声明（\documentclass ...）。
    2. 必须引入的宏包（packages）。
    3. 标题、作者、摘要和章节的特定格式要求。
  expected_output: >
    一份详细的模板分析摘要，包含确切的模板名称、\documentclass 设置命令，
    以及该期刊排版所需的关键宏包列表和注意事项。
  agent: template_researcher_agent

# 任务3：排版工程师的任务 - 协调与集成
latex_generation_task:
  description: >
    扮演核心协调员的角色。汇总以下来源的所有信息：
    1. 文档解析器提供的结构化文本内容（来自 context），包含了文章的标题、作者、章节正文。注意，这里的公式块可能只有图片路径。
    2. equation_recognition_task 提供的 OCR 公式片段。
    3. template_retrieval_task 提供的模板格式规则。

    将这些信息合并为一个完整、逻辑连贯且语法正确的 .tex 源文件。
    具体要求：
    - 将文本中的公式占位符替换为 OCR 识别出的 LaTeX 代码。
    - 严格应用目标期刊的模板结构（如 \section, \author, \abstract）。
    - 确保所有的宏包引用完整，且图片路径正确。
  expected_output: >
    一段完整、可直接用于编译的 .tex 源代码字符串。
    代码必须包含标准的 LaTeX 文档开始和结束标记。
  agent: latex_coder_agent

# 任务4：调试专家的任务 - 编译与闭环修复
compilation_debugging_task:
  description: >
    获取上一步生成的 .tex 代码，并调用 Docker 沙盒工具进行编译。
    执行以下“编译-调试”循环：
    1. 尝试编译 .tex 文件。
    2. ⚠️ 重要：调用工具时，必须将 **{journal_name}** 赋值给工具的 template_dir_path 参数。
    3. 如果编译成功：记录 PDF 文件路径，任务结束。
    4. 如果编译失败：读取编译错误日志（log），分析具体错误原因（如“宏包缺失”、“未定义的命令”、“语法错误”）,根据错误信息，智能修改 .tex 源代码以修复问题。
    5. 再次尝试编译，直到成功或达到最大重试次数。
  expected_output: >
    最终的状态报告。
    如果成功，应包含“编译成功”的标记、经过修正的最终版 .tex 代码以及生成的 PDF 文件路径。
    如果失败，应包含详细的错误原因分析。
  agent: latex_debugger_agent